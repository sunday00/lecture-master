<%- include('../partials/header') %>

<% if (cart && cart.length > 0) { %>
<h1>장바구니</h1>
<table class="table">
    <thead>
        <tr>
            <th scope="col">이미지</th>
            <th scope="col">이름</th>
            <th scope="col">가격</th>
            <th scope="col">개수</th>
            <th scope="col">변경</th>
            <th scope="col">가격</th>
        </tr>
    </thead>
    <tbody>
        <% let total = 0 %>
        <% cart.forEach(product => { %>
        <% let sub = product.qty * product.price  %>
        <% total += +sub %>
        <tr>
            <td><img style="width:100px;" src="<%= product.image %>" alt="product"></td>
            <td><%= product.title %></td>
            <td><%= product.price %></td>
            <td><%= product.qty %></td>
            <td>
                <a class="btn btn-primary" href="/cart/update/<%= product.title %>?action=add">+</a>&nbsp;
                <a class="btn btn-danger" href="/cart/update/<%= product.title %>?action=remove">-</a>&nbsp;
                <a class="btn btn-dark" href="/cart/update/<%= product.title %>?action=clear">clear</a>&nbsp;
            </td>
            <td><%= sub %>원</td>
        </tr>
        <% }) %>
        <tr>
            <td colspan="5"></td>
            <td>
                <b>합계:</b> <%= total %>
            </td>
        </tr>
        <tr>
            <td colspan="4"></td>
            <td>
                <form action="/cart?_method=DELETE" method="POST">
                    <input name="_method" value="DELETE" type="hidden" />
                    <button class="clearcart btn btn-danger">장바구니 비우기</button>
                </form>
            </td>
            <td>
                <a class="btn btn-primary buyout" onclick="requestPay()">결제하기</a>
            </td>
        </tr>
    </tbody>
</table>
<% } else { %>
<h3>장바구니가 비어있습니다.</h3>
<% } %>

<script>
    var IMP = window.IMP;
    IMP.init('imp63568358') // 예: 'imp00000000a'

    function requestPay() {
        IMP.request_pay({
            pg: "kakaopay.TC0ONETIME",
            // pay_method: "card", // 생략가
            merchant_uid: "order_no_0005", // 상점에서 생성한 고유 주문번호
            name: "주문명:결제테스트",
            amount: 100,
            buyer_email: "kind65505256@gmail.com",
            buyer_name: "sunday00",
            buyer_tel: "010-6550-5256",
            buyer_addr: "kor",
            buyer_postcode: "123-456",
            // m_redirect_url: "http://localhost:4000/cart/checkout"
        }, function (rsp) { // callback
            if (rsp.success) {
                console.log('success:', rsp);
                fetch('/cart/complete/order', {
                        method: 'POST',
                        body: JSON.stringify(rsp),
                    }).then((res) => {
                        location.href = '/products'
                    })
            } else {
                console.log(`결제에 실패하였습니다. 에러 내용: ${rsp.error_msg}`);
            }
        });
    }
</script>


<%- include('../partials/footer') %>