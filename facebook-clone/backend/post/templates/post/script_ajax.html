<!-- unibeautify:disable  -->
<script>
  (function () {
    const delegation = document.querySelector('#contents_container');
    const textField = document.querySelector('#text_field');

    function delegationFunc(e) {
      let elem = e.target;

      while (!elem.getAttribute('data-name')) {
        elem = elem.parentNode;

        if (elem.nodeName === 'BODY') {
          elem = null;
          return;
        }
      }

      if (elem.matches('[data-name="like"]')) {
        let pk = elem.getAttribute('name');

        $.post(`{% url 'post:post_like' %}`, 
          {
            pk: pk,
            csrfmiddlewaretoken: '{{ csrf_token }}',
          }
        ).then(res => {
          document.querySelector(`#like-count-${pk}`).textContent = res.like_count;
          elem.classList.toggle('active');
        }).catch(err => {
          console.log(err);
        });
      }

      if (elem.matches('[data-name="bookmark"]')) {
        let pk = elem.getAttribute('name');

        $.post(`{% url 'post:post_bookmark' %}`, 
          {
            pk: pk,
            csrfmiddlewaretoken: '{{ csrf_token }}',
          }
        ).then(res => {
          elem.firstElementChild.textContent = res.is_bookmarked === 'Y' ? 'saved' : 'save';
        }).catch(err => {
          console.log(err);
        });
      }

      if (elem.matches('[data-name="friend_request"]')) {
        let pk = elem.getAttribute('name');

        $.post(`{% url 'accounts:create_friend_request' %}`, 
          {
            pk: pk,
            csrfmiddlewaretoken: '{{ csrf_token }}',
          }
        ).then(res => {
          elem.dataset.name = 'cancel_add_friend';
          elem.textContent = 'cancel requesting';
        }).catch(err => {
          console.log(err);
        });
      }

      if (elem.matches('[data-name="cancel_add_friend"]')) {
        let to_user = elem.getAttribute('name');

        $.post(`{% url 'accounts:cancel_add_friend' %}`, 
          {
            to_user: to_user,
            csrfmiddlewaretoken: '{{ csrf_token }}',
          }
        ).then(res => {
          elem.dataset.name = 'friend_request';
          elem.textContent = 'add friend';
        }).catch(err => {
          console.log(err);
        });
      }
    }

  delegation.addEventListener('click', delegationFunc);
})();
</script>
